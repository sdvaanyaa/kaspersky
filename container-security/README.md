# Task Queue Service

Сервис на Go для асинхронной обработки задач с внутренней очередью и пулом воркеров.

---

## Основные возможности

1. **Прием задач через HTTP**
    - POST `/enqueue`
    - Тело JSON:
      ```json
      {
        "id": "<string>",
        "payload": "<string>",
        "max_retries": <int>
      }
      ```
    - Задачи добавляются в буферизированную очередь (`QUEUE_SIZE`).

2. **Пул воркеров**
    - Количество воркеров настраивается через `WORKERS` (по умолчанию 4).
    - Каждая задача "обрабатывается" 100–500 мс (симулированная работа).
    - 20% задач могут падать (симулированные ошибки) — используется экспоненциальный бэкофф с джиттером.
    - Поддержка повторов до `max_retries`.
    - Хранение и обновление состояния задач:
        - `queued` — в очереди
        - `running` — в обработке
        - `done` — выполнено
        - `failed` — ошибка после всех повторов

3. **Healthcheck**
    - GET `/healthz` → 200 OK.

4. **Корректное завершение**
    - Обрабатываются сигналы `SIGINT` / `SIGTERM`.
    - Перестаем принимать новые задачи.
    - Дожидаемся завершения текущих задач.

---

## Архитектурные решения

- **WorkerPool**
    - Структура с очередью задач, воркерами и состоянием задач.
    - Позволяет управлять параллельной обработкой и контролем состояния.

- **workFunc**
    - Симуляция работы вынесена в отдельную функцию (`simulateWork`) для тестирования и гибкости.
    - В тестах можно подставить свою функцию, чтобы проверять поведение воркеров без задержек и случайных ошибок.

- **State Management**
    - Каждая задача хранится в `taskStates` с блокировкой (`stateMu`), чтобы избежать гонок при обновлении состояния.

- **Конфигурация**
    - Параметры `WORKERS` и `QUEUE_SIZE` берутся из окружения или Makefile.
    - При некорректных значениях используются безопасные дефолты.

---

## Запуск

```bash
# Сборка + запуск с дефолтными параметрами
make run
````
```bash
# Сборка + запуск с кастомными параметрами
make run WORKERS=8 QUEUE_SIZE=128
```
```bash
# Очистка артефактов сборки
make clean
```

---

## Примеры запросов

### Healthcheck

**Запрос:**

```bash
curl -v http://localhost:8080/healthz
```

**Ответ:**

HTTP/1.1 200 OK

### Добавление задачи в очередь

**Запрос:**

```bash
curl -v -X POST http://localhost:8080/enqueue \
     -H "Content-Type: application/json" \
     -d '{
           "id": "task1",
           "payload": "do something",
           "max_retries": 3
         }'
```

**Ответ:**

HTTP/1.1 202 Accepted

---

## Тестирование

Прогон всех тестов:

```bash
make test
```
